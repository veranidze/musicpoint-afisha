<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админка — Music Point</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f3f4f6; color: #22223b; font-family: 'Inter', sans-serif; }
        .glass-effect { background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); border: 1px solid #e5e7eb; }
        .dropzone { border: 2px dashed #a5b4fc; background: #eef2ff; color: #6366f1; transition: border-color 0.2s; }
        .dropzone.dragover { border-color: #6366f1; background: #e0e7ff; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-weight: bold; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .toast.show { opacity: 1; visibility: visible; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-3xl mx-auto py-10 px-4">
        <h1 class="text-3xl font-bold mb-8 text-center">Администрирование событий</h1>
        <form id="event-form" class="glass-effect p-6 rounded-xl mb-8">
            <input type="hidden" id="event-id">
            <div class="mb-4">
                <label class="block mb-1 font-semibold">Название</label>
                <input id="title" type="text" class="w-full p-2 rounded bg-white border border-gray-300" required>
            </div>
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label class="block mb-1 font-semibold">Жанр</label><input id="genre" type="text" class="w-full p-2 rounded bg-white border" required></div>
                <div><label class="block mb-1 font-semibold">Дата</label><input id="date" type="date" class="w-full p-2 rounded bg-white border" required></div>
                <div><label class="block mb-1 font-semibold">Время</label><input id="time" type="text" placeholder="20:00" class="w-full p-2 rounded bg-white border" required></div>
            </div>
            <div class="mb-4"><label class="block mb-1 font-semibold">Описание</label><textarea id="fullDescription" class="w-full p-2 rounded bg-white border" rows="3"></textarea></div>
            <div class="mb-4">
                <label class="block mb-1 font-semibold">Изображения (первое будет главным)</label>
                <div id="dropzone" class="dropzone flex flex-col items-center justify-center p-4 rounded cursor-pointer mb-2">
                    <span id="dropzone-text">Перетащите файлы сюда или <span class="underline text-indigo-600 cursor-pointer" id="upload-btn">выберите</span></span>
                </div>
                <input id="imageFiles" type="file" accept="image/*" class="hidden" multiple>
                <div id="gallery-preview" class="flex flex-wrap gap-4 mt-4"></div>
            </div>
            <div class="flex items-center">
                <button type="submit" id="submit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded mt-2 flex items-center">
                    <span id="submit-btn-text">Сохранить</span>
                    <div id="submit-loader" class="loader ml-2 hidden"></div>
                </button>
                <button type="button" id="cancel-edit" class="ml-4 text-gray-500 hover:text-indigo-700">Отмена</button>
            </div>
        </form>
        <div id="events-list"><div class="text-center text-gray-400 py-10">Загрузка событий...</div></div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        // --- Настройки ---
        const API_BASE_URL = 'http://16.170.141.43:3000';

        // --- DOM Элементы ---
        const form = document.getElementById('event-form');
        const eventsList = document.getElementById('events-list');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const dropzone = document.getElementById('dropzone');
        const imageFilesInput = document.getElementById('imageFiles');
        const galleryPreview = document.getElementById('gallery-preview');
        const toast = document.getElementById('toast');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const submitLoader = document.getElementById('submit-loader');

        let existingImageUrls = []; // URL уже загруженных картинок при редактировании
        let filesToUpload = []; // Новые файлы для загрузки

        // --- UI ---
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            submitBtnText.style.display = isLoading ? 'none' : 'block';
            submitLoader.style.display = isLoading ? 'block' : 'none';
        }

        // --- Управление изображениями ---
        dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
        dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('dragover'); });
        dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        document.getElementById('upload-btn').onclick = () => imageFilesInput.click();
        imageFilesInput.onchange = () => {
            if (imageFilesInput.files.length) {
                handleFiles(imageFilesInput.files);
                imageFilesInput.value = '';
            }
        };

        function handleFiles(files) {
            filesToUpload.push(...Array.from(files));
            renderGalleryPreview();
        }

        function renderGalleryPreview() {
            galleryPreview.innerHTML = '';
            // Рендер существующих URL
            existingImageUrls.forEach((url, idx) => {
                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `<img src="${API_BASE_URL}${url}" class="w-24 h-16 object-cover rounded shadow border bg-gray-100" /><button type="button" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs remove-existing" data-idx="${idx}">&times;</button>`;
                galleryPreview.appendChild(div);
            });
            // Рендер новых файлов
            filesToUpload.forEach((file, idx) => {
                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `<img src="${URL.createObjectURL(file)}" class="w-24 h-16 object-cover rounded shadow border-2 border-indigo-400" /><button type="button" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs remove-new" data-idx="${idx}">&times;</button>`;
                galleryPreview.appendChild(div);
            });

            galleryPreview.querySelectorAll('.remove-existing').forEach(btn => {
                btn.onclick = () => { existingImageUrls.splice(+btn.dataset.idx, 1); renderGalleryPreview(); };
            });
            galleryPreview.querySelectorAll('.remove-new').forEach(btn => {
                btn.onclick = () => { filesToUpload.splice(+btn.dataset.idx, 1); renderGalleryPreview(); };
            });
        }

        // --- Форматирование даты ---
        const formatDateForDisplay = (dateStr) => {
            if (!dateStr) return '';
            const [yyyy, mm, dd] = dateStr.split('T')[0].split('-');
            return `${dd}.${mm}.${yyyy}`;
        };

        // --- CRUD ---
        async function fetchEvents() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/events`);
                if (!response.ok) throw new Error('Ошибка сети');
                const events = await response.json();
                renderEvents(events);
            } catch (error) {
                console.error('Ошибка загрузки событий:', error);
                showToast('Ошибка загрузки событий', 'error');
            }
        }

        function renderEvents(events) {
            eventsList.innerHTML = '';
            if (!events.length) {
                eventsList.innerHTML = '<div class="text-center text-gray-400 py-10">Событий нет. Создайте первое!</div>';
                return;
            }
            events.forEach(event => {
                const div = document.createElement('div');
                const imageUrl = event.gallery && event.gallery.length > 0 ? `${API_BASE_URL}${event.gallery[0]}` : 'https://placehold.co/128x80/e0e7ff/4f46e5?text=Img';
                div.className = 'glass-effect mb-4 p-4 rounded-lg flex flex-col sm:flex-row items-center gap-4';
                div.innerHTML = `
                    <img src="${imageUrl}" alt="" class="w-32 h-20 object-cover rounded shadow border bg-gray-100">
                    <div class="flex-1 text-center sm:text-left">
                        <div class="font-bold text-lg">${event.title}</div>
                        <div class="text-sm text-indigo-600">${event.genre} — ${formatDateForDisplay(event.date)} / ${event.time}</div>
                    </div>
                    <div class="flex flex-col gap-2 w-full sm:w-auto">
                        <button class="edit-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded w-full">Редактировать</button>
                        <button class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded w-full">Удалить</button>
                    </div>`;
                div.querySelector('.edit-btn').addEventListener('click', () => editEvent(event));
                div.querySelector('.delete-btn').addEventListener('click', () => deleteEvent(event.id));
                eventsList.appendChild(div);
            });
        }

        function resetForm() {
            form.reset();
            document.getElementById('event-id').value = '';
            filesToUpload = [];
            existingImageUrls = [];
            renderGalleryPreview();
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            setLoading(true);

            const id = document.getElementById('event-id').value;
            const url = id ? `${API_BASE_URL}/api/events/${id}` : `${API_BASE_URL}/api/events`;
            const method = id ? 'PUT' : 'POST';

            // Используем FormData для отправки файлов и текста вместе
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('genre', document.getElementById('genre').value);
            formData.append('date', document.getElementById('date').value);
            formData.append('time', document.getElementById('time').value);
            formData.append('fullDescription', document.getElementById('fullDescription').value);
            
            // Добавляем новые файлы для загрузки
            filesToUpload.forEach(file => formData.append('gallery', file));
            // Добавляем существующие URL
            existingImageUrls.forEach(url => formData.append('existingImages', url));

            try {
                const response = await fetch(url, { method: method, body: formData });
                if (!response.ok) throw new Error('Ошибка сервера');
                showToast(id ? 'Событие обновлено!' : 'Событие создано!');
                resetForm();
                fetchEvents();
            } catch (error) {
                showToast('Ошибка сохранения', 'error');
                console.error('Ошибка:', error);
            } finally {
                setLoading(false);
            }
        };

        function editEvent(event) {
            resetForm();
            document.getElementById('event-id').value = event.id;
            document.getElementById('title').value = event.title;
            document.getElementById('genre').value = event.genre;
            document.getElementById('date').value = event.date.split('T')[0]; // Форматируем дату для input
            document.getElementById('time').value = event.time;
            document.getElementById('fullDescription').value = event.fullDescription;
            
            existingImageUrls = event.gallery || [];
            renderGalleryPreview();
            window.scrollTo(0, 0);
        }

        async function deleteEvent(id) {
            if (confirm(`Удалить это событие?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/events/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Ошибка удаления');
                    showToast('Событие удалено.');
                    fetchEvents();
                } catch (error) {
                    showToast('Ошибка удаления', 'error');
                    console.error('Ошибка:', error);
                }
            }
        }
        
        cancelEditBtn.onclick = resetForm;

        // --- Initial Load ---
        fetchEvents();
    </script>
</body>
</html>
